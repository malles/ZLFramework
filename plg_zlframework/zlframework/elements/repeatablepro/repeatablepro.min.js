(function(a){var e=function(){};a.extend(e.prototype,{name:"ElementRepeatablePro",options:{msgDeleteElement:"Delete Element",msgSortElement:"Sort Element",msgLimitReached:"Limit reached",instanceLimit:"",url:""},initialize:function(b,e){this.options=a.extend({},this.options,e);var c=this,d=a("ul.repeatable-list",b),g=a("li.hidden",d).remove(),h=a("li.repeatable-element",d).length;c.element=b;c.list=d;c.count=h;c.options.msgAddInstance=a("p.add a",b).html();a("li.repeatable-element",d).each(function(){a(this).children().wrapAll(a("<div>").addClass("repeatable-content")); c.attachButtons(a(this))});d.on("mousedown",".zlux-x-sort",function(){a(".more-options.show-advanced",d).removeClass("show-advanced");d.height(d.height());a(this).closest("li.repeatable-element").find(".more-options").hide().end().find(".file-details").hide()}).on("mouseup",".zlux-x-sort",function(){a(this).closest("li.repeatable-element").find(".more-options").show().end().find(".file-details").show()}).on("click",".zlux-x-delete",function(){a(this).closest("li.repeatable-element").fadeOut(200,function(){a(this).remove(); b.trigger("instance.deleted");c.options.instanceLimit&&a("p.add a",b).removeClass("disabled").html(c.options.msgAddInstance)})}).sortable({handle:".zlux-x-sort",placeholder:"repeatable-element dragging",axis:"y",opacity:1,delay:100,cursorAt:{top:16},tolerance:"pointer",containment:"parent",scroll:!1,start:function(b,c){c.item.addClass("ghost");c.placeholder.height(c.item.height()-2);c.placeholder.width(a("div.repeatable-content",c.item).width()-2)},stop:function(c,b){b.item.removeClass("ghost");a(".more-options", b.item).show();a(".file-details",b.item).show();d.height("");a(".repeatable-element",a(c.target)).each(function(b){a('[name^="elements"]',a(this)).each(function(){var c=a(this).attr("name").replace(/(elements\[\S+])\[(-?\d+)\]/g,"$1["+b+"]");a(this).attr("name",c)})})}});a("p.add a",b).on("click",function(){if(c.options.instanceLimit&&c.options.instanceLimit<=d.children().length)return!1;c.addElementInstance(g.html());c.options.instanceLimit&&c.options.instanceLimit<=d.children().length&&a("p.add a", b).addClass("disabled").html(c.options.msgLimitReached)})},loadElementInstance:function(b,e){var c=this;a.ajax({url:c.options.ajax_url+"&task=callelement",type:"POST",data:{method:"getemptylayout",layout:b},success:function(a){c.addElementInstance(a);c.element.trigger("instance.added",[a,e])}})},addElementInstance:function(b){b=b.replace(/(elements\[\S+])\[(-?\d+)\]/g,"$1["+this.count++ +"]");b=a('<li class="repeatable-element"><div class="repeatable-content">'+b+"</div></li>");this.attachButtons(b); a("input, textarea",b).filter(function(){return"hidden"!=a(this).attr("type")}).each(function(){a(this).val("").html("")});b.appendTo(this.list);b.children("div.repeatable-content").effect("highlight",{},1E3)},attachButtons:function(b){a(".zlux-x-sort, .zlux-x-delete",b)[0]||(a("<span>").addClass("zlux-x-sort sort").attr("title",this.options.msgSortElement).appendTo(b),a("<span>").addClass("zlux-x-delete delete").attr("title",this.options.msgDeleteElement).appendTo(b))}});a.fn[e.prototype.name]=function(){var b= arguments,f=b[0]?b[0]:null;return this.each(function(){var c=a(this);if(e.prototype[f]&&c.data(e.prototype.name)&&"initialize"!=f)c.data(e.prototype.name)[f].apply(c.data(e.prototype.name),Array.prototype.slice.call(b,1));else if(!f||a.isPlainObject(f)){var d=new e;e.prototype.initialize&&d.initialize.apply(d,a.merge([c],b));c.data(e.prototype.name,d)}else a.error("Method "+f+" does not exist on jQuery."+e.name)})}})(jQuery);